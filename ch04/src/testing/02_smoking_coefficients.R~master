
<<<<<<< HEAD:ch04/src/testing/02_smoking_stats_and_coefficients.R
# read National Health Interview Survey (NHIS) and NATS data and estimate initiation rates
=======
# National Health Interview Survey (NHIS) and NATS data and estimate initiation rates
>>>>>>> master:ch04/src/testing/02_smoking_coefficients.R

library(haven)
library(data.table)
library(survey)
library(muhaz)
library(xlsx)
table = function (...) base::table(..., useNA = 'ifany')


# read NHIS 2019
h = fread("data/health_survey_adults.csv")
setnames(h, names(h), tolower(names(h)))
setnames(i, names(i), tolower(names(i)))
setnames(h, "wtfa_a", "wt")

table(h$smkev_a)
table(h$smknow_a)
<<<<<<< HEAD:ch04/src/testing/02_smoking_stats_and_coefficients.R

=======
table(h$srvy_yr)

names(h)
>>>>>>> master:ch04/src/testing/02_smoking_coefficients.R
h[, smoking := 0]
h[smkev_a == 1 & smknow_a %in% c(1, 2), smoking := 1]
h[smkev_a %in% c(7, 8, 9), smoking := NA]
h[smknow_a %in% c(7, 8), smoking := NA]
table(h$smoking)

h[, age_group := ifelse(agep_a >= 30 & agep_a <= 50, 1, 0)]
h[age_group == 1, incomeType:= cut(faminctc_a, breaks = quantile(faminctc_a, probs = 0:3/3),
    labels = 1:3, right = TRUE, include.lowest = TRUE)]

table(h[age_group == 1, incomeType])

h[, incomeType2 := ifelse(incomeType == 2, 1, 0)]
h[, incomeType3 := ifelse(incomeType == 3, 1, 0)]

s = h[age_group == 1]

design = svydesign(ids=~hhx, weights=~wt, data=s)
h[, weighted.mean(smoking, wt, na.rm = TRUE), incomeType]

m = svyglm(smoking ~ incomeType2 + incomeType3, design = design, family=quasibinomial)
summary(m)

# read date
dat = data.table(read_sas("data/nats_2013.sas7bdat"))
setnames(dat, "wt_national", "wt")
summary(dat$wt)

dat[, flag := ifelse(smok100 == 1 |
    (age %in% 18:29 & smok100 %in% c(2, -8, -7) & smoknow %in% 1:2) | smokever == 1, 1, 0)]

setnames(dat, c("SMOKEVER_R2", "SMOKESTATUS3_R2"), c("sever", "scurrent"))
table(dat$sever)
table(dat$scurrent)

dat[sever == 3, sever := NA]
dat[scurrent == 7, scurrent:= NA]
dat[, sever := ifelse(sever == 1, 1, 0)]
dat[, scurrent:= ifelse(scurrent == 1, 1, 0)]

table(dat$sever)
table(dat$scurrent)
# proportion of ever smokers and current smokers
dat[, weighted.mean(sever, wt, na.rm = TRUE)]
dat[, weighted.mean(scurrent, wt, na.rm = TRUE)]
dat[age %in% 30:40, weighted.mean(sever, wt, na.rm = TRUE)]
dat[age %in% 30:40, weighted.mean(scurrent, wt, na.rm = TRUE)]

# skip pattern for age of initiation
# /ASK IF Q3 SMOK100 EQ
# 1 OR (Q2 AGE EQ (18-29)
# AND Q3 SMOK100 EQ
# (2,-8,-7) AND Q4
# SMOKNOW EQ (1,2)) OR
# Q13 SMOKEVER EQ 1/

# only valid age
dat = dat[age > 0]
summary(dat$age)
nrow(dat)
dat[smokfirstage %in% c(-8, -7), smokfirstage := NA]
dat[, init := smokfirstage]
dat[, init := ifelse(init == -1, age, smokfirstage)]
dat[, smoking := ifelse(smokfirstage == -1, 0, 1)]

names(dat)
ss = Surv(dat$init, dat$smoking)
m = survfit(ss ~ 1, data = dat)
m = summary(m)
m$n.event / m$n.risk

# income categories
table(dat$income2)
dat[, incometype := NULL]
dat[income2 %in% 1:2, incometype := 1]
dat[income2 %in% 3:5, incometype := 2]
dat[income2 %in% 6:8, incometype := 3]
table(dat$incometype)

dat[, .(sever = weighted.mean(sever, wt, na.rm = TRUE),
    weighted.mean(scurrent, wt, na.rm = TRUE)), incometype]

dat[, incometype := factor(incometype, levels = c(2, 1, 3))]

# logistic model
m1 = glm(scurrent ~ incometype, data = dat)
summary(m1)
res_cox = coxph(Surv(init, smoking) ~ incometype, data = dat)

sdat = dat[!is.na(init), .(init, smoking, incometype, wt = round(wt))]
sdat = sdat[rep(seq(.N), wt), !"wt"]

# expand data
mh = muhaz(sdat$init, sdat$smoking)
summary(mh)
plot(mh, xlab = "Age", ylab = "Smoking initiation hazard rate")
rates = data.table(age = 1:length(mh$haz.est), rate = mh$haz.est)
rates =  rates[age > 64, rate := 0][age <= 65]
# write.xlsx(rates, "models/MobHealthRecycling/data/smoking-rates.xlsx", row.names = FALSE)